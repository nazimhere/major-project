<%- layout("/layouts/boiler_plate") %>

<div class="row mt-4">
    <div class="col-8 offset-2">
        <h3 class="mb-4"><i><b><%= listing.title %></b></i></h3>

        <!-- Listing Card -->
        <div class="listing-card show-card mx-auto mb-4" style="max-width: 5000px;height: 50%;">
            <img src="<%= listing.image || '/images/default.jpg' %>"
                 class="card-img-top show-img"
                 alt="<%= listing.title %>"
                 style="height: 300px; object-fit: cover;">

            <div class="card-body">
                <h5 class="card-title">
                    <i class="fa-solid fa-map-marker-alt me-2"></i>
                    <%= listing.title %>
                </h5>

                <ul class="list-unstyled offset-1">
                    <li class="mb-2"><strong>Description:</strong> <%= listing.description || 'No description' %></li>
                    <li class="mb-2"><strong>Price:</strong> ₹<%= (listing.price || 0).toLocaleString("en-IN") %></li>
                    <li class="mb-2"><strong>Location:</strong> <%= listing.location || listing.place || 'Not specified' %></li>
                    <li class="mb-2"><strong>Country:</strong> <%= listing.country || 'Not specified' %></li>
                    <li class="mb-2"><strong>Owner:</strong> <i><%= listing.owner?.username || 'Not specified' %></i></li>
                </ul>
               <!-- <div class="reverse  offset-5"> 
                   <a href="/listings/<%= listing._id %>"> <button type="submit" class=" reserve-glow  btn-sm px-4 py-2">
                            <i class="fas fa-plus me-2"></i>Reserve
                        </button></a>
                </div>-->
                <!-- BOOK NOW BUTTON - Add to action-buttons section -->
<!-- SMART BOOK NOW BUTTON -->
<% const hasBooking = listing.bookings && listing.bookings.some(b => b.author.equals(currentUser?._id)); %>
<a href="/bookings/new/<%= listing._id %>" 
   class="btn btn-success btn-lg px-5  offset-4 book-now-glow <%= hasBooking ? 'disabled' : '' %>"
   <%= hasBooking ? 'onclick="return false;"' : '' %>>
  <% if (hasBooking) { %>
    <i class="fas fa-check-circle me-2"></i>Already Booked!
  <% } else { %>
    <i class="fas fa-calendar-check me-2"></i>Book Now
  <% } %>
</a>

<!-- SUCCESS ALERT - Show booking confirmation -->
<% if (typeof success !== 'undefined' && success.length > 0) { %>
  <div class="alert alert-success alert-dismissible fade show shadow-lg border-0" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    <%= success[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<% if (typeof error !== 'undefined' && error.length > 0) { %>
  <div class="alert alert-danger alert-dismissible fade show shadow-lg border-0" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <%= error[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>



                <div class="btn-group d-flex gap-2 mt-4 offset-0.5 rem" role="group">
                    <a href="/listings/<%= listing._id %>" class="btn btn-primary">
                        <i class="fa-solid fa-eye me-1"></i>View
                    </a>

                    <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">
                        <i class="fa-solid fa-pen-to-square me-1"></i>Edit
                    </a>

                    <form method="POST"
                          action="/listings/<%= listing._id %>?_method=DELETE"
                          style="display: inline;"
                          onsubmit="return confirm('Are you sure you want to delete this listing?')">
                        <button type="submit" class="btn btn-danger">
                            <i class="fa-solid fa-trash me-1"></i>Delete
                        </button>
                    </form>
                </div>

                <a href="/listings" class="btn btn-secondary mt-3 offset-1">Back</a>
                <br>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="card mt-4">
            <div class="card-body">

                <!-- Review Form -->
                <h4>Leave a Review</h4>
                <form action="/listings/<%= listing._id %>/reviews" method="post">
                 

      <form action="/listings/<%= listing._id %>/reviews" method="post">
    <!-- ⭐ STARS ONLY -->
    <div class="star-rating mb-3">
        <% for(let i = 1; i <= 5; i++) { %>
            <input type="radio" id="star<%= i %>" 
                   name="review[rating]" 
                   value="<%= i %>" 
                   <%= i === 1 ? 'checked' : '' %> required>
            <label for="star<%= i %>">★</label>
        <% } %>
    </div>
    
    <div class="mb-3">
        <label for="comment" class="form-label">Comment</label>
        <textarea name="review[comment]" id="comment" class="form-control" rows="4" required></textarea>
    </div>
    <button type="submit" class="btn btn-dark">Submit Review</button>
</form>

                <hr>

                <!-- Reviews list header -->
                <h5>All Reviews</h5>

                <!-- Reviews grid -->
                <div class="row">
                    <% if(listing.reviews && listing.reviews.length > 0) { %>
                        <% listing.reviews.forEach(function(review) { %>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <!-- Use dynamic reviewer name if available -->
                                            <%= review.author?.username || 'User' %>
                                        </h6>

                                        <p class="card-text"><%= review.comment %></p>

                                        <p class="card-text">
                                            <%= Array(review.rating).fill("⭐").join("") %>
                                        </p>

                                        <form method="POST"
                                              action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                                              style="display:inline;">
                                            <button type="submit" class="btn btn-dark btn-sm"
                                                    onclick="return confirm('Delete this review?')">
                                                Delete
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="col">
                            <p>No reviews yet.</p>
                        </div>
                    <% } %>
                    <br>
                </div>
            </div>
        </div>
        <br><br>
    </div>
</div>