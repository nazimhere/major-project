<% layout('layouts/boiler_plate') -%>
<div class="container my-5">
  <!-- PAGE HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-5">
    <div>
      <h1 class="display-4 fw-bold text-dark mb-2">
        <i class="fas fa-calendar-check text-success me-3"></i>
        My Bookings
      </h1>
      <p class="lead text-muted mb-0">Manage your upcoming trips</p>
    </div>
    <a href="/listings" class="btn btn-outline-secondary btn-lg">
      <i class="fas fa-arrow-left me-2"></i>Browse Listings
    </a>
  </div>

  <!-- SUCCESS/ERROR MESSAGES -->
  <% if (typeof success !== 'undefined' && success.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show shadow-lg border-0 mb-4" role="alert">
      <i class="fas fa-check-circle me-2"></i><%= success[0] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>

  <% if (typeof error !== 'undefined' && error.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show shadow-lg border-0 mb-4" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i><%= error[0] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>

  <!-- NO BOOKINGS MESSAGE -->
  <% if (!bookings || bookings.length === 0) { %>
    <div class="text-center py-5 my-5">
      <i class="fas fa-calendar-times fa-5x text-muted mb-4 opacity-75"></i>
      <h3 class="text-muted mb-3">No bookings yet</h3>
      <p class="text-muted mb-4">Book your first stay and manage it here!</p>
      <a href="/listings" class="btn btn-success btn-lg px-5">
        <i class="fas fa-search me-2"></i>Find Stays
      </a>
    </div>
  <% } else { %>

    <!-- BOOKINGS LIST - FULLY SAFE -->
    <div class="row g-4">
      <% bookings.forEach(booking => { %>
        <div class="col-xl-4 col-lg-6">
          <div class="card h-100 booking-card glass-effect border-0 shadow-xl position-relative overflow-hidden">
            
            <!-- IMAGE - SAFE -->
            <div class="position-relative">
              <img src="<%= (booking.listing && booking.listing.image) || 'https://via.placeholder.com/300x220/6c757d/ffffff?text=No+Image' %>" 
                   class="card-img-top booking-img" 
                   alt="<%= (booking.listing && booking.listing.title) || 'Booking' %>"
                   style="height: 220px; object-fit: cover;">
              
              <div class="position-absolute top-0 end-0 m-3">
                <span class="badge bg-success fs-6 px-3 py-2">Confirmed</span>
              </div>
            </div>
            
            <!-- CONTENT - FULLY SAFE -->
            <div class="card-body d-flex flex-column p-4">
              <div class="mb-3">
                <!-- SAFE TITLE -->
                <h5 class="card-title fw-bold mb-2">
                  <%= (booking.listing && booking.listing.title) || 'Listing Unavailable' %>
                </h5>
                
                <!-- SAFE LOCATION -->
                <p class="text-muted mb-2">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  <%= (booking.listing && booking.listing.location) || 'N/A' %>, 
                  <%= (booking.listing && booking.listing.country) || 'N/A' %>
                </p>
              </div>

              <!-- DATES - ALWAYS SAFE -->
              <div class="booking-dates mb-4 p-3 bg-light rounded-3 border">
                <div class="row text-center g-0">
                  <div class="col-6 border-end">
                    <small class="text-muted d-block">Check-in</small>
                    <div class="fw-bold fs-5 text-primary">
                      <%= booking.startDate.toLocaleDateString('en-IN') %>
                    </div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted d-block">Check-out</small>
                    <div class="fw-bold fs-5 text-primary">
                      <%= booking.endDate.toLocaleDateString('en-IN') %>
                    </div>
                  </div>
                </div>
              </div>

              <!-- PRICE & GUESTS - SAFE PRICE -->
              <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                <div>
                  <small class="text-muted d-block">Guests</small>
                  <div class="fw-bold text-success fs-5"><%= booking.guests %></div>
                </div>
                <div class="text-end">
                  <small class="text-muted d-block">Per night</small>
                  <div class="h5 fw-bold text-warning mb-0">
                    â‚¹<%= (booking.listing && booking.listing.price) ? booking.listing.price.toLocaleString() : 'N/A' %>
                  </div>
                </div>
              </div>

              <!-- ACTION BUTTONS - SAFE LINKS -->
              <div class="mt-auto d-grid gap-2">
                <% if (booking.listing && booking.listing._id) { %>
                  <a href="/listings/<%= booking.listing._id %>" class="btn btn-outline-primary btn-lg py-2">
                    <i class="fas fa-eye me-2"></i>View Details
                  </a>
                <% } else { %>
                  <button class="btn btn-secondary btn-lg py-2 disabled" disabled>
                    <i class="fas fa-eye-slash me-2"></i>Listing Deleted
                  </button>
                <% } %>
                
                <!-- CANCEL BUTTON - ALWAYS SAFE -->
                <!-- CANCEL FORM - WORKING VERSION -->


              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<style>
  .glass-effect {
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.3);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .glass-effect:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
  }
  .booking-img {
    transition: transform 0.4s ease;
  }
  .glass-effect:hover .booking-img {
    transform: scale(1.05);
  }
  .cancel-btn {
    transition: all 0.3s ease;
  }
  .cancel-btn:hover {
    background: #dc3545 !important;
    color: white !important;
    transform: translateY(-1px);
  }
  .booking-dates {
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
